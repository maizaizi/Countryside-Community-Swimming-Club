{% extends 'memberhome.html' %}

{% block subcontent %}
<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4 text-center">My Bookings</h2>
        
        <!-- Display flash messages -->
        {% for message in get_flashed_messages() %}
            <div class="alert alert-danger" role="alert">{{ message }}</div>
        {% endfor %}
        
        <!-- Display bookings table -->
        {% if booked_classes %}
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Class Name</th>
                        <th>Class Image</th>
                        <th>Class Time</th>
                        <th>Instructor</th>
                        <th>Price</th>
                        <th>Action</th>
                        <th>Status</th>
                        <th>Payment</th>
                        
                    </tr>
                </thead>
                <tbody>
                    {% for schedule_info in booked_classes %}
                        <tr>
                            <td>{{ schedule_info.class_date }}</td>
                            <td>{{ schedule_info.class_name }}</td>
                            <td>
                                <img src="{{ url_for('static', filename='images/' + schedule_info.class_image) }}" alt="Class Image" style="max-width: 100px;" >
                            </td>
                            <td>{{ schedule_info.time }}</td>
                            <td>{{ schedule_info.instructor }}</td>
                            <td>{{ schedule_info.price }}</td>
                            <td>
                                {%if schedule_info.booking_status!='completed'%}
                                <button class="btn btn-outline-danger" onclick="confirmCancelBooking({{schedule_info.booking_id}})">Cancel Booking</button>
                                {%endif%}
                            </td>
                            <td>{{ schedule_info.booking_status.capitalize() }}</td>
                            <td>
                                {% if schedule_info.class_type == 'Individual Lesson' and (schedule_info.booking_status == 'confirmed' or schedule_info.booking_status == 'completed') %}
                                    Paid
                                {% elif schedule_info.class_type == 'Individual Lesson' %}
                                    <a href="{{ url_for('member.show_payment_form', booking_id=schedule_info.booking_id) }}" class="btn btn-outline-primary">Pay</a>
                                {% else %}
                                    No Payment Required
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

<script>
    // Define the backend route for canceling bookings
    const cancelBookingRoute = '/member/cancel_booking/';

    function confirmCancelBooking(bookingId) {
        Swal.fire({
            title: 'Are you sure?',
            text: 'You are about to cancel this booking.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, cancel it!'
        }).then((result) => {
            if (result.isConfirmed) {
                cancelBooking(bookingId);
            }
        });
    }

    function cancelBooking(bookingId) {
        fetch(cancelBookingRoute + bookingId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Include any required headers, such as CSRF tokens.
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display a notification if cancellation is successful
                Swal.fire('Cancelled!', data.message, 'success');
                // Refresh the page or perform other UI updates if needed
                setTimeout(() => window.location.reload(), 2000);
            } else {
                // Display an error notification if cancellation fails
                Swal.fire('Error!', data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Display an error notification if an error occurs during cancellation
            Swal.fire('Error!', 'Failed to cancel booking. Please try again later.', 'error');
        });
    }


    
</script>
</body>
</html>
{% endblock %}
